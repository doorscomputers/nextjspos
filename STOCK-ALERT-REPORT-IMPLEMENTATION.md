# Stock Alert Report Implementation - October 10, 2025

## Overview

Converted the Product Stock Alert from a dashboard widget to a dedicated printable report page per location. This reduces clutter on the dashboard and provides a comprehensive, print-friendly view of low stock items.

## Changes Made

### 1. Dashboard Widget Simplified ✅

**File:** `src/app/dashboard/page.tsx`

**Before:**
- Showed detailed table with product names, SKUs, quantities
- Displayed all 10 low-stock items in a table format
- Took up significant space on dashboard

**After:**
- Shows summary card with total low-stock count
- Displays badge with number of items below alert level
- Includes "View Detailed Report" button
- Redirects to full report page

```typescript
<Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => window.location.href = '/dashboard/reports/stock-alert'}>
  <CardHeader>
    <CardTitle className="flex items-center justify-between">
      <div className="flex items-center gap-2">
        <ExclamationTriangleIcon className="h-5 w-5 text-orange-600" />
        Low Stock Alert
      </div>
      <Badge variant="destructive" className="text-lg px-3 py-1">
        {stats?.tables.stockAlerts.length || 0}
      </Badge>
    </CardTitle>
  </CardHeader>
  <CardContent>
    <div className="space-y-2">
      <p className="text-sm text-gray-600">
        {stats?.tables.stockAlerts.length === 0
          ? "All products are well stocked"
          : `${stats?.tables.stockAlerts.length} product(s) below alert level`}
      </p>
      <button className="w-full mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
        <ExclamationTriangleIcon className="h-4 w-4" />
        View Detailed Report
      </button>
    </div>
  </CardContent>
</Card>
```

---

### 2. Stock Alert Report API ✅

**File:** `src/app/api/reports/stock-alert/route.ts`

**Features:**
- Fetches all products with alert quantity set
- Filters by location (specific location or all locations)
- Calculates:
  - Total products monitored
  - Low stock count
  - Current quantity vs alert quantity
  - Shortage amount
  - Percentage of alert level
- Returns detailed product information including category and location

**Response Format:**
```json
{
  "success": true,
  "data": {
    "locationId": "all",
    "locationName": "All Locations",
    "totalProducts": 12,
    "lowStockCount": 11,
    "alerts": [
      {
        "id": 1,
        "productId": 1,
        "productName": "Generic Mouse",
        "variationName": "Default",
        "sku": "PCI-0001",
        "category": "Computer Peripherals",
        "locationId": 1,
        "locationName": "Main Warehouse",
        "currentQty": 40,
        "alertQty": 500,
        "difference": 460,
        "percentageOfAlert": 8
      }
    ]
  }
}
```

---

### 3. Stock Alert Report Page ✅

**File:** `src/app/dashboard/reports/stock-alert/page.tsx`

**Features:**

#### Display Features
- **Summary Cards:**
  - Total Products Monitored
  - Low Stock Items Count
  - Stock Health Percentage

- **Detailed Table:**
  - Product name and variation
  - Category
  - SKU
  - Location
  - Current quantity (with destructive badge)
  - Alert quantity
  - Shortage amount
  - Status badge (Critical/Low/Warning/Alert based on percentage)

#### Interactive Features
- Location filter dropdown (All Locations or specific location)
- Back button to return to previous page
- Print button for generating printable report
- Real-time data fetching based on location filter

#### Print Optimization
- Print header with:
  - Report title
  - Business name
  - Location name
  - Generated date/time
  - Generated by user
- Hides navigation controls when printing
- Optimized table layout for printing
- Print footer with report ID

#### Status Color Coding
- **Critical** (0-25%): Red background
- **Low** (26-50%): Orange background
- **Warning** (51-75%): Yellow background
- **Alert** (76-100%): Blue background

---

### 4. Sidebar Navigation ✅

**File:** `src/components/Sidebar.tsx`

**Added:** Stock Alert Report to Reports submenu

```typescript
{
  name: "Stock Alert Report",
  href: "/dashboard/reports/stock-alert",
  icon: ExclamationTriangleIcon,
  permission: PERMISSIONS.PRODUCT_VIEW,
}
```

**Location:** Reports → Stock Alert Report (first item in submenu)

---

## How It Works

### User Flow

1. **Dashboard View:**
   - User sees summary card on dashboard
   - Card shows number of low-stock items
   - Click anywhere on card or "View Detailed Report" button

2. **Report Page:**
   - Loads full Stock Alert Report
   - Shows summary statistics at top
   - Displays detailed table of all low-stock items
   - Can filter by location using dropdown
   - Can print report using Print button

3. **Print Flow:**
   - Click "Print Report" button
   - Browser print dialog opens
   - Report shows professional header and footer
   - Navigation controls hidden automatically
   - Optimized layout for printing

4. **Location Filtering:**
   - Select location from dropdown
   - Report refreshes with location-specific data
   - Shows only low-stock items at selected location
   - "All Locations" shows items across all locations

---

## API Endpoint

### GET `/api/reports/stock-alert`

**Query Parameters:**
- `locationId` (optional): Location ID to filter by, or "all" for all locations

**Authentication:** Required (NextAuth session)

**Permissions:** `PRODUCT_VIEW`

**Response:** JSON with report data including alerts array

---

## File Structure

```
src/
├── app/
│   ├── api/
│   │   └── reports/
│   │       └── stock-alert/
│   │           └── route.ts          # API endpoint
│   ├── dashboard/
│   │   ├── page.tsx                  # Dashboard with summary card
│   │   └── reports/
│   │       └── stock-alert/
│   │           └── page.tsx          # Full report page
└── components/
    └── Sidebar.tsx                   # Navigation with report link
```

---

## Testing Steps

### 1. Dashboard Summary Card
```bash
1. Navigate to http://localhost:3006/dashboard
2. Verify Low Stock Alert card shows count (should be 11)
3. Click on card or "View Detailed Report" button
4. Should redirect to /dashboard/reports/stock-alert
```

### 2. Report Page Display
```bash
1. Navigate to http://localhost:3006/dashboard/reports/stock-alert
2. Verify summary cards show:
   - Total Products Monitored: 12
   - Low Stock Items: 11
   - Stock Health: 8%
3. Verify detailed table shows all low-stock products
4. Check status badges show correct colors (Critical/Low/Warning)
```

### 3. Location Filtering
```bash
1. On report page, click location dropdown
2. Select "Main Warehouse"
3. Verify data refreshes and shows only Main Warehouse items
4. Select different location
5. Verify data updates accordingly
6. Select "All Locations"
7. Verify all low-stock items shown again
```

### 4. Print Functionality
```bash
1. Click "Print Report" button
2. Verify print preview shows:
   - Professional header with business name
   - Location name
   - Generated date/time and user
   - All table data
   - Print footer with report ID
3. Verify navigation controls are hidden
4. Verify table layout looks clean
5. Print or save as PDF to confirm
```

### 5. Permissions
```bash
1. Login with different user roles
2. Users with PRODUCT_VIEW permission should see:
   - Low Stock Alert card on dashboard
   - Stock Alert Report link in sidebar
   - Can access /dashboard/reports/stock-alert
3. Users without PRODUCT_VIEW should not see any of the above
```

---

## Database Query Logic

### Fetching Low Stock Items

```typescript
// 1. Get ALL products with alert quantity set
const allProductsWithAlerts = await prisma.variationLocationDetails.findMany({
  where: {
    ...(locationId && locationId !== 'all' ? { locationId: parseInt(locationId) } : {}),
    product: {
      businessId,
      alertQuantity: { not: null },
    },
  },
  include: {
    product: { /* fields */ },
    productVariation: { /* fields */ },
    location: { /* fields */ },
  },
})

// 2. Filter to find products where current quantity <= alert quantity
const stockAlerts = allProductsWithAlerts.filter((item) => {
  const alertQty = parseFloat(item.product.alertQuantity.toString())
  const currentQty = parseFloat(item.qtyAvailable.toString())
  return alertQty > 0 && currentQty <= alertQty
})
```

**Why This Approach:**
1. Fetches all products with alerts (not just first 10)
2. Filters in memory for low-stock conditions
3. Returns complete dataset for reporting
4. No limit on report (unlike dashboard which limits to 10)
5. Location-aware via `variationLocationDetails` table

---

## Benefits

### Before (Dashboard Widget)
- ❌ Cluttered dashboard with large table
- ❌ Limited to 10 items
- ❌ No print functionality
- ❌ No detailed information
- ❌ Not suitable for physical reports

### After (Dedicated Report)
- ✅ Clean dashboard with summary card
- ✅ Shows all low-stock items (no limit)
- ✅ Professional print layout
- ✅ Detailed information (category, location, shortage, status)
- ✅ Perfect for physical inventory management
- ✅ Location-specific filtering
- ✅ Exportable as PDF via browser print

---

## Related Files

- `src/app/dashboard/page.tsx` - Dashboard with summary card
- `src/app/api/reports/stock-alert/route.ts` - Report API endpoint
- `src/app/dashboard/reports/stock-alert/page.tsx` - Full report page
- `src/components/Sidebar.tsx` - Navigation menu
- `src/app/api/dashboard/stats/route.ts` - Dashboard stats API (unchanged, still provides count)

---

## Next Steps (Future Enhancements)

1. **Export to Excel/CSV**
   - Add export button to download report as spreadsheet
   - Include all columns and calculations

2. **Email Report**
   - Schedule daily/weekly low stock email alerts
   - Send report to inventory manager automatically

3. **Reorder Suggestions**
   - Calculate suggested reorder quantities
   - Link to create purchase order directly from report

4. **Historical Trends**
   - Show stock level trends over time
   - Predict when items will reach zero

5. **Custom Alert Thresholds**
   - Per-location alert levels
   - Per-product custom thresholds
   - Seasonal adjustment factors

---

## Status

✅ **COMPLETE** - Stock Alert Report fully implemented and ready for testing

---

**Implementation Date:** October 10, 2025
**Developer:** Claude Code AI Assistant
**Requested By:** User (Warenski)
