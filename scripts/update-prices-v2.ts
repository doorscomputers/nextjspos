/**
 * Script to update product prices from Excel data (Update Prices.xlsx)
 * Run with: DATABASE_URL="your-connection-string" npx tsx scripts/update-prices-v2.ts
 */

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// Price data from Update Prices.xlsx: Item Name -> New Selling Price
const priceUpdates: Record<string, number> = {
  "HIKSEMI 8GB DDR4 3200 LODIMM": 2930,
  "PATRIOT 8GB DDR4 3200 LODIMM": 2480,
  "PNY 16GB DDR4 3200 LODIMM": 6190,
  "XPG 8GB DDR4 3600 LODIMM": 4750,
  "GSKILL TRIDENTZ NEO 16GB DDR4 3600 LODIMM": 7560,
  "TFORCE VULCAN 8GB DDR4 3600 LODIMM": 3200,
  "GSKILL TRIDENTZ NEO 16GB DDR4 4000 LODIMM": 10660,
  "ADATA 8GB DDR5 4800 LODIMM": 3820,
  "ADATA 16GB DDR5 5600 LODIMM 1.1V": 8980,
  "VIPER 32GB DDR5 6000 LODDIMM": 17140,
  "VIPER 32GB DDR5 6200 LODIMM": 17710,
  "KINGSTON KVR24S17S8/8 8GB DDR4 2400 SODIMM": 4160,
  "KINGSTON HYPERX 8GB DDR4 2666 SODIMM": 6280,
  "KINGSTON VALUE 16GB DDR4 2666 SODIMM": 7630,
  "NETAC 8GB DDR4 2666 SODIMM": 3200,
  "HIKSEMI 16GB DDR4 3200 SODIMM": 4320,
  "HIKSEMI 8GB DDR4 3200 SODIMM": 2480,
  "KINGSTON VALUE 8GB DDR4 3200 SODIMM": 4030,
  "PATRIOT 16GB DDR4 3200 SODIMM": 5130,
  "ADATA 32GB DDR5 4800 SODIMM": 10030,
  "ADATA 16GB DDR5 5600 SODIMM 1.1V": 11610,
  "KINGSTON VALUE 8GB DDR5 5600 SODIMM": 4900,
  "TEAM GROUP 16GB DDR5 5600 SODIMM": 6390,
  "HIKVISION MICROSDHD CARD 32GB": 320,
  "SANDISK GAMEPLAY 128GB MICRO-SD SDSQXAA-128G-GN6XN": 1350,
  "SANDISK ULTRA MICROSDHC UHS-I CARD 32GB SDSQUA4-032G-GN6MN": 560,
  "SANDISK ULTRA MICROSDHC UHS-I CARD 16GB SDSQUAR-016G-GN6MN": 390,
  "TRANSCEND MICROSDHC UHS-I CARD WITH ADAPTER 350V 128GB TS128GUSD350V": 1670,
  "TRANSCEND ULTRA MICROSDHC UHS-I CARD 64GB 340S TS64GUSD340S": 1170,
  "SANDISK EXTREME PRO 32GB SDSQXCG-032G-GN6MA": 840,
  "SANDISK EXTREME 32GB MICROSDHC SDSQXAF-032G-GN5MN": 680,
  "TRANSCEND MICROSDHC UHS-I CARD WITH ADAPTER 300S 128GB TS128GUSD300S-A": 1210,
  "TRANSCEND MICROSDHC UHS-I CARD WITH ADAPTER 300S 64GB TS64GUSD300S-A": 680,
  "TRANSCEND MICROSDHC UHS-I CARD WITH ADAPTER 300S 32GB TS32GUSD300S-A": 520,
  "TRANSCEND MICROSDHC UHS-I CARD WITH ADAPTER 340S 128GB TS128GUSD340S-A": 1890,
  "SANDISK EXTREME MICROSDXC 128GB SDSQXAA-128G-GN6MN": 1600,
  "SANDISK HIGH ENDURANCE MSDXC 64GB SDSQQNR-064G-GN6IA": 950,
  "SANDISK EXTREME MICROSDXC UHS-I CARD 64GB SDSQXAH-064G-GN6MN": 880,
  "SANDISK EXTREME PRO MICROSDXC UHS-I CARD WITH ADAPTER 128GB SDSQXCD-128G-GN6MA": 1750,
  "SANDISK HIGH ENDURANCE MICROSDXC 512GB SDSQQNR-512G-GNGIA": 4770,
  "SANDIS ULTRA 64GB MICROSDXC SDSQUAB-064G-GN6MN": 580,
  "SANDISK EXTREME PRO MICROSDXC UHS-I WITH ADAPTER 64GB SDSQXCU-064G-GN6MA": 990,
  "SANDISK MAX ENDURANCE 128GB SDSQQVR-128G-GN6IA": 3150,
  "TRANSCEND MICROSDXC UHS-I CARD WITH ADAPTER 256GB 300S TS256GUSD300S-A": 2970,
  "TRANSCEND SD CARD UHS-I CARD 128GB TS128GSDC340S": 1890,
  "TRANSCEND SDXC UHS-I CARD 128GB 300S TS128GSDC300S": 740,
  "TRANSCEND SDHS UHS-I CARD 64GB 340S TS64GSDC340S": 1210,
  "TRANSCEND SDHC UHS-I CARD 32GB 300S TS32GSDC300S": 700,
  "SANDISK EXTREME PRO SDXC UHS-I CARD 256GB SDSDXXD-256G-GN4IN": 4410,
  "TRANSCEND SDXC UHS-I CARD 300S 64GB TS64GSDC300S": 890,
  "HIKSEMI 1TB 2.5 SSD": 6930,
  "WD 1TB 2.5 SSD": 7360,
  "HIKSEMI 256GB 2.5 SSD": 2610,
  "ADATA 512GB 2.5 SSD": 3740,
  "HIKSEMI 512GB 2.5 SSD": 3580,
  "PATRIOT 512GB 2.5 SSD": 4820,
  "TRANSCEND ESD310C 128GB OTG TYPE C EXTERNAL SSD": 2570,
  "ADATA SC610 1TB EXTERNAL SSD": 7690,
  "HIKSEMI HS-ESSD T300S PORTABLE SSD 1TB TYPE C": 7880,
  "KINGSTON XS1000 1TB EXTERNAL SSD": 9520,
  "TRANSCEND ESD380C 1TB EXTERNAL SSD": 13590,
  "TRANSCEND ESD270C 1TB EXTERNAL SSD TYPE C USB 3.1 GEN 2": 9320,
  "HIKSEMI HS-ESSD T300S PORTABLE SSD 2TB TYPE C": 16040,
  "TRANSCEND ESD270C 500GB EXTERNAL SSD TYPE C USB 3.1 GEN 2": 6030,
  "ADATA SC610 500GB EXTERNAL SSD": 5540,
  "TRANSCEND ESD310C 512GB EXTERNAL SSD": 7760,
  "TRANSCEND ESD380C 500GB EXTERNAL SSD": 7760,
  "TRANSCEND ESD300C 512GB EXTERNAL SSD TYPE C": 6030,
  "TRANSCEND ESD300S 512GB EXTERNAL SSD TYPE C": 6030,
  "RAMSTA 128GB M.2 NVME SSD": 3220,
  "HIKSEMI 1TB M.2 NVME SSD GEN4": 7690,
  "PATRIOT 256GB M.2 NVME SSD": 3280,
  "HIKSEMI 512GB M.2 NVME SSD GEN3": 4460,
  "HIKSEMI 512GB M.2 NVME SSD GEN4": 5170,
  "WD BLUE 500GB M.2 NVME SSD": 4820,
  "SANDISK OTG 64GB SDDD3-064G-G464W": 670,
  "SANDISK OTG 128GB SDDD3-128G-G46": 1190,
  "SANDISK ULTRA DUAL DRIVE 32GB USB MINI 3.0 SDDD3-032G-G46": 740,
  "SANDISK OTG DUAL DRIVE 64GB": 830,
  "SANDISK PHONE DRIVE 128GB TYPE C SDDDC6-128G-G46": 1310,
  "SANDISK SDDDC3-032G-G46 32GB ULTRA DUAL DRIVE GO TYPE C": 540,
  "TRANSCEND JF890 64GB OTG TYPE C": 1760,
  "TRANSCEND JF890 32GB OTG TYPE C USB 3.1": 1550,
  "TRANSCEND JF790C 128G OTG TYPE C": 1190,
  "DAHUA 16GB USB 2.0 DHI-U116-20-16GB": 340,
  "SANDISK CRUZER BLADE 64GB USB 2.0 SDCZ50-064G-B35": 670,
  "SANDISK CRUZER BLADE 32GB USB 2.0 SDCZ50C-032G-B35BE": 470,
  "SANDISK CRUZER BLADE 32GB USB 2.0 SDCZ50C-032G-B35PE": 470,
  "TRANSCEND JF590 32GB USB 2.0 TS32GJF590K": 560,
  "TRANSCEND JF590 64GB 2.0 TS64GJF590K": 740,
  "TRANSCEND JF350 64GB 2.0": 720,
  "TRANSCEND JF350 32GB USB 2.0 TS32GJF350": 560,
  "HIKSEMI HS-USB-M200 32GB USB 3.0": 450,
  "HIKSEMI HS-USB-M200 128GB USB 3.0": 1040,
  "HIKSEMI HS-USB-M220P 128GB USB 3.0": 1040,
  "HIKSEMI HS-USB-M220P 32GB USB 3.0": 490,
  "HIKSEMI HS-USB-M220P 64GB USB 3.2": 740,
  "HIKSEMI HS-USB-M200 64GB USB 3.0": 630,
  "HIKSEMI HS-USB-M200S 32GB USB 3.0": 490,
  "SANDISK ULTRA SHIFT 128GB USB 3.1 SDCZ410-128G-G46": 1040,
  "SANDISK IXPAND LUXE 128GB USB 3.0 SDIX70N-128G-GN6NE": 5020,
  "SANDISK ULTRA FIT 32GB 3.1": 740,
  "SANDISK CRUZER ULTRA 3.0 128GB, SDCZ48-128G-U46": 1280,
  "SANDISK ULTRA FIT 64GB 3.1": 760,
  "SANDISK ULTRA LUXE 64GB USB 3.0 SDCZ74-064G-G46": 860,
  "SANDISK ULTRA LUXE 128GB USB 3.2 GEN 1 SDCZ74-128G-G46": 1310,
  "SANDISK CRUZER ULTRA FLAIR 16GB 3.0 SDCZ73-016G-G46": 580,
  "SANDISK CRUZER ULTRA 3.0 64GB SDCZ48-064G-U46": 590,
  "SANDISK CRUZER ULTRA FLAIR 64GB 3.0 SDCZ73-064G-G46": 590,
  "SANDISK SMURFS 64GB USB 3.2 GEN 1 SDCZIS-064G-G46": 1750,
  "SANDISK CRUZER ULTRA 3.0 32GB SDCZ48-032G-U46": 520,
  "TRANSCEND JF920 512GB USB 3.2 GEN 1 TS512GJF920": 5490,
  "TRANSCEND JF920 128GB USB 3.2 GEN 1 TS128GJF920": 2380,
  "TRANSCEND JF810 64GB 3.1": 1030,
  "TRANSCEND JF920 256GB USB 3.2 GEN 1 TS256GJF920": 3370,
  "TRANSCEND JF700 32GB USB 3.1": 670,
  "TRANSCEND JF730 128GB USB 3.1 GEN 1 TS128GJF730": 1080,
  "TRANSCEND JF730 64GB PEN DRIVE CLASSIC": 700,
  "TRANSCEND JF790 64GB 3.1": 880,
  "TRANSCEND JF790 32GB USB 3.1 GEN 1 TS32GJF790K": 670,
  "TRANSCEND JF700 64GB USB 3.1 GEN 1 TS64GJF700": 880,
  "TRANSCEND JF790 128GB USB 3.1 GEN 1 TS128GJF790K": 1080,
  "TRANSCEND JF730 32GB USB 3.1 GEN 1 TS32GJF730": 670,
  "SANDISK ULTRA TYPEC 128GB SDCZ450-128G-G46": 1400,
  "SANDISK ULTRA TYPEC 64GB SDCZ450-064G-G46": 920,
  "SANDISK ULTRA TYPEC 32GB SDCZ450-032G-G46": 790,
  "TRANSCEND JF790C 64GB OTG TYPE C": 1040,
}

async function main() {
  console.log('Starting price update from Update Prices.xlsx...')
  console.log(`Total products to update: ${Object.keys(priceUpdates).length}`)

  // Get businessId 1
  const businessId = 1

  // Get only ACTIVE locations
  const locations = await prisma.businessLocation.findMany({
    where: {
      businessId,
      isActive: true  // Only active locations
    },
    select: { id: true, name: true },
  })

  console.log(`Found ${locations.length} active locations`)

  let updatedCount = 0
  let notFoundCount = 0
  const notFound: string[] = []

  for (const [itemName, newPrice] of Object.entries(priceUpdates)) {
    // Find product by name (case-insensitive)
    const product = await prisma.product.findFirst({
      where: {
        businessId,
        name: {
          equals: itemName,
          mode: 'insensitive',
        },
      },
      include: {
        variations: {
          select: { id: true },
        },
      },
    })

    if (!product) {
      notFoundCount++
      notFound.push(itemName)
      continue
    }

    // Update all variations for all active locations
    for (const variation of product.variations) {
      for (const location of locations) {
        await prisma.variationLocationDetails.upsert({
          where: {
            productVariationId_locationId: {
              productVariationId: variation.id,
              locationId: location.id,
            },
          },
          update: {
            sellingPrice: newPrice,
            lastPriceUpdate: new Date(),
          },
          create: {
            productId: product.id,
            productVariationId: variation.id,
            locationId: location.id,
            qtyAvailable: 0,
            sellingPrice: newPrice,
            lastPriceUpdate: new Date(),
          },
        })
      }
    }

    updatedCount++
    console.log(`Updated: ${itemName} -> â‚±${newPrice.toLocaleString()}`)
  }

  console.log('\n--- SUMMARY ---')
  console.log(`Updated: ${updatedCount} products`)
  console.log(`Not found: ${notFoundCount} products`)

  if (notFound.length > 0) {
    console.log('\nProducts not found in database:')
    notFound.forEach(name => console.log(`  - ${name}`))
  }

  console.log('\nPrice update complete!')
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
